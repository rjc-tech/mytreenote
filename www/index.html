<!DOCTYPE html>
<!--HTML5 doctype-->
<html>

<head>
    <title>App Framework Kitchen Sink</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" type="text/css" href="lib/appframework/icons.css" />
    <link rel="stylesheet" type="text/css" href="lib/appframework/af.ui.css" />
    <script type="text/javascript" charset="utf-8" src="lib/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/fastclick.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/appframework/appframework.ui.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/mytreenote.js"></script>
    <script src='cordova.js'></script>

    <script>
        jQuery(document).ready(function ($) {

            // データの永続保存用ストレージ
            var g_LocalStorage = localStorage;
            //g_LocalStorage.clear();
            // 一時リスト作成用ストレージ
            var g_tempListStorage = sessionStorage;
            // パンくずリスト
            var g_topicPathList = {};
            // トピックID一時保存用
            var g_holdTopic;
            // シーケンスなければ作成
            if (!g_LocalStorage.getItem("TOPIC_ID_SEQ")) {
                g_LocalStorage.setItem("TOPIC_ID_SEQ", 0)
            }
            // リスト作成
            window.onload = function () {
                // ツリーの作成
                createTree();
            }

            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // ■ JSONのソート■
            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            var sort_by = function (prop_name, reverse, primer) {

                reverse = (reverse) ? -1 : 1;
                return function (a, b) {
                    a = a[prop_name];
                    b = b[prop_name];

                    if (typeof (primer) != 'undefined') {
                        a = primer(a);
                        b = primer(b);
                        //                        // ★デバッグ用 
                        //                        navigator.notification.alert("a→" + a);
                        //                        // ★デバッグ用 
                        //                        navigator.notification.alert("b→" + b);
                    }
                    if (a < b) return reverse * -1;
                    if (a > b) return reverse * 1;
                    return 0;
                }
            }

            // ■■■■■■■■■■■■■■■■■■
            // ■  ツリーを作成する ■
            // ■■■■■■■■■■■■■■■■■■
            function createTree() {

                // ★デバッグ用 
                //                navigator.notification.alert("createTreeにはいった");

                g_tempListStorage.clear();

                // カレントトピック存在フラグ
                var currentFlg = false;
                for (var i = 0; i < g_LocalStorage.length; i++) {
                    var json = JSON.parse(g_LocalStorage.getItem(g_LocalStorage.key(i)));
                    // カレントトピックを見つけたらリストの作成
                    if (json.CURRENT_TOPIC_FLG == 1) {

                        var currentTopicId = json.TOPIC_ID;

                        // カレントトピック配下のトピックのリストを作成していく
                        for (var a = 0; a < g_LocalStorage.length; a++) {
                            var childJson = JSON.parse(g_LocalStorage.getItem(g_LocalStorage.key(a)));
                            var childPathList = new String(childJson.PATH).split("~");
                            // カレントトピックのトピックIDがパスに含まれていたら子トピックとして追加
                            for (var b = 0; b < childPathList.length; b++) {
                                if (currentTopicId == childPathList[b]) {
                                    g_tempListStorage.setItem(g_LocalStorage.key(a), JSON.stringify(childJson));
                                    break;
                                }
                            }
                        }

                        // カレントトピックの親を取得しパンくずリストを作成
                        g_topicPathList = {};

                        var parentPathList = new String(json.PATH).split("~");

                        for (var a = 0; a < g_LocalStorage.length; a++) {
                            var parentJson = JSON.parse(g_LocalStorage.getItem(g_LocalStorage.key(a)));
                            // 親トピックをリストに追加
                            for (var b = 0; b < parentPathList.length; b++) {
                                if (parentJson.TOPIC_ID == parentPathList[b]) {
                                    g_topicPathList[g_LocalStorage.key(a)] = JSON.stringify(parentJson);
                                    break;
                                }
                            }
                        }
                        // カレントトピックの作成
                        document.getElementById('currentTopic').innerHTML = '<span class="topicText" data-id="' + json.TOPIC_ID + '">' + json.TOPIC_TEXT + '</span>';
                        currentFlg = true;
                        break;
                    }
                }
                // カレントトピックが存在しない場合は全てのトピックのリストを作成
                if (!currentFlg) {

                    // ソートするため、LocalStorageのデータを一旦json形式のオブジェクトに格納
                    var jsonList = []
                    for (var i = 0; i < g_LocalStorage.length; i++) {
                        jsonList.push(
                            JSON.parse(g_LocalStorage.getItem(g_LocalStorage.key(i)))
                        )
                    }
                    // ソートの実行
                    //jsonList.sort(sort_by('PARENT_TOPIC_ID', false, parseInt));
                    jsonList.sort(sort_by('ORDER', false, parseInt));

                    // ソート結果を一時リスト作成用ストレージへ格納
                    for (var i in jsonList) {
                        g_tempListStorage.setItem(jsonList[i].TOPIC_ID, JSON.stringify(jsonList[i]));
                    }
                }

                //上記で作成した一時リストに保存されているデータからツリーを作成する

                // --------------ツリー本体ここから--------------
                var resultTree = "";
                if (g_tempListStorage.length > 0) {
                    resultTree = "<ul>";
                }
                // 保存されているデータの数だけループしリスト作成
                for (var i = 0; i < g_tempListStorage.length; i++) {
                    var k = g_tempListStorage.key(i);
                    var json = JSON.parse(g_tempListStorage.getItem(k));

                    // トピックが展開中か折り畳み中かによって黒丸の表示を変える
                    var topicSircle = "◎";
                    if (json.OPEN_FLG == 1) {
                        topicSircle = "・";
                    }

                    // インデント調整
                    var jsonPathList = new String(json.PATH).split("~");
                    resultTree +=
                        '<li style="padding-left:' + (jsonPathList.length - 1) * 10 + 'px"><span class="moveTopic" data-id="' + json.TOPIC_ID + '">' + topicSircle + '</span><span class="topicText" data-id="' + json.TOPIC_ID + '">' + json.TOPIC_TEXT + '</span></li>';

                }
                if (resultTree != "") {
                    resultTree += "</ul>";
                }
                // リスト表示
                document.getElementById("show_result").innerHTML = resultTree;
                // --------------ツリー本体ここまで--------------

                // --------------パンくずリストここから--------------
                // 保存されているデータの数だけループしリスト作成。最初に「home」を追加し、カレントなしの状態に戻れるようにする
                var resultTopic = '<span class="moveTopic" data-id="home">home</span>';
                for (var key in g_topicPathList) {
                    var json = JSON.parse(g_topicPathList[key]);
                    resultTopic += '&nbsp;<span class="moveTopic" data-id="' + json.TOPIC_ID + '">' + json.TOPIC_TEXT + "</span>";
                }
                // リスト表示
                document.getElementById("topicPathList").innerHTML = resultTopic;
                // --------------パンくずリストここまで--------------
            }


            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // ■タップした丸点orパンくずリストのトピックをカレントトピックにする■
            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            $(document).on('click', '.moveTopic', function () {


                // 現在カレントトピックフラグが1になっているデータを0に更新する
                for (var i = 0; i < g_LocalStorage.length; i++) {
                    var otherJson = JSON.parse(g_LocalStorage.getItem(g_LocalStorage.key(i)));

                    if (otherJson.CURRENT_TOPIC_FLG == "1") {
                        otherJson.CURRENT_TOPIC_FLG = "0";
                        g_LocalStorage.setItem(otherJson.TOPIC_ID, JSON.stringify(otherJson));
                        break;
                    }
                }

                // idが"home"ならばパンくずリストを初期化
                if ($(this).data("id") == "home") {
                    g_topicPathList = {};

                } else {
                    // idが"home"でない場合は、カレントトピックフラグを更新。
                    // トピックIDをキーに、タップされた該当のトピックのカレントトピックフラグを1に更新
                    var topicId = $(this).data("id");
                    var json = JSON.parse(g_LocalStorage.getItem(topicId));

                    json.CURRENT_TOPIC_FLG = "1";
                    g_LocalStorage.setItem(topicId, JSON.stringify(json));
                }

                // カレントトピックの作成
                document.getElementById('currentTopic').innerHTML = '';
                currentFlg = true;
                createTree();
            });


            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // ■トピックがタップされたら編集モードに■
            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            $(document).on('click', '.topicText', function () {

                var selectTopicId = $(this).data("id")
                    // ★デバッグ用 
                    //navigator.notification.alert("selectTopicId→" + selectTopicId);

                if (selectTopicId != "new_edit") {
                    if (!$(this).hasClass('on')) {

                        $(this).addClass('on');
                        var txt = $(this).text();
                        $(this).html('<input type="text" class="topicText" value="' + txt + '" />');

                        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                        // ■既存トピックのフォーカスアウト(内容の保存)■
                        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                        $('.topicText > input').change(function () {

                            var inputVal = $(this).val();
                            // ★デバッグ用 
                            //navigator.notification.alert("既存トピックのフォーカスアウト");
                            $(this).parent().removeClass('on').text(inputVal);
                            // 保存
                            updateTopicText(selectTopicId, inputVal);
                            // 再描画
                            createTree();

                        })

                        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                        // ■          階層上げ             ■
                        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                        $('#classUp').click(function () {
                            // トピックを選択していない場合は機能しない
                            // ★デバッグ用 
                            // navigator.notification.alert("トピックの階層を一つ上げます" + selectTopicId);
                            hierarchyUpMove(selectTopicId);
                            // 再描画
                            createTree();
                        });

                        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                        // ■          階層下げ             ■
                        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                        $('#classDown').click(function () {
                            // トピックを選択していない場合は機能しない
                            // ★デバッグ用 
                            // navigator.notification.alert("トピックの階層を一つ下げます" + selectTopicId);
                            hierarchyUnderMove(selectTopicId);
                            // 再描画
                            createTree();
                        });
                    }
                }
            });

            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // ■新規入力欄のフォーカスアウト(トピックの作成)■
            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            $('#new_edit').blur(function () {

                // 入力値があればトピックの登録処理
                var topicId = $(this).data("id");
                var inputVal = $(this).val();

                if (inputVal != "") {
                    // ★デバッグ用 
                    // navigator.notification.alert("入力値→" + inputVal);
                    //カレントトピックが存在しないなら親、存在するならカレントトピックの子として作成する
                    // ★デバッグ用 
                    //navigator.notification.alert("inputVal" + inputVal);
                    // ★デバッグ用 
                    //navigator.notification.alert("new_editのフォーカスアウト");
                    var existParent = false;
                    for (var i = 0; i < g_LocalStorage.length; i++) {
                        var json = JSON.parse(g_LocalStorage.getItem(g_LocalStorage.key(i)));
                        // カレントトピックを見つけたらそのトピックの子として作成する
                        if (json.CURRENT_TOPIC_FLG == 1) {
                            topicId = createTopic(json.TOPIC_ID);
                            updateTopicText(topicId, inputVal);
                            existParent = true;
                            break;
                        }
                    }
                    // 親がいない場合(カレントトピックがない場合)
                    if (!existParent) {
                        // 空のトピックを作成
                        topicId = createParentTopic();
                        // ★デバッグ用 
                        // navigator.notification.alert(topicId);
                        // 保存
                        updateTopicText(topicId, inputVal);
                    }
                    // 新規追加欄を空白に
                    $(this).val("");
                    // 新規追加欄を非表示に
                    $('#new_edit').hide();
                    // 再描画
                    createTree();
                }
            });


            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // ■          トピック追加          ■
            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // 追加処理自体は上記の「トピックがタップされたら編集モードに」で行っているため、ここで行うのは編集欄の可視化のみ
            $('#addTopic').click(function () {
                $('#new_edit').show().focus();
            });

            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // ■          トピック削除          ■
            // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
            // 長押しを検知してトピックを削除
            $(document).on('touchstart', '.moveTopic', function () {
                timerid = setTimeout(function () {　　
                    // ポップアップで削除可否を確認
                    if (!confirm('削除します。よろしいですか？')) {
                        // キャンセル
                        return false;
                    } else {
                        //　OK
                        deleteTopic($(this).data("id"));
                    }
                }, 750);
            });
        });


        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
        // ■ このアプリについて             ■
        // ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
        function openOss() {
            $("#main").css("display", "none");
            $("#oss1").css("display", "none");
            $("#oss2").css("display", "");
        }

        function appliTop() {
            $("#main").css("display", "");
            $("#oss1").css("display", "");
            $("#oss2").css("display", "none");
            changeVisivility(false);
            $('#for_top')[0].click();
        }

        function changeVisivility(select_top) {
            if (select_top) {
                $("#drawer_top_rect").hide();
                $("#drawer_about_rect").show();
            } else {
                $("#drawer_top_rect").show();
                $("#drawer_about_rect").hide();
            }
        }
    </script>
</head>

<body>
    <div id="splashscreen" class='ui-loader heavy'>App Framework
        <br>
        <br>
        <span class='ui-icon ui-icon-loading spin'></span>
        <h1>Starting app</h1>
    </div>
    <div class="view splitview">
        <header>
            <a class="menuButton" data-left-menu="left" data-transition="cover" style="float:left"></a>
            <h1>Title</h1>
        </header>
        <div class="pages">
            <div class="panel" id="main" data-title="Main" data-selected="true">
                <!--階層を上げたり下げたりするボタン-->
                <span id="classUp">↑</span><span id="classDown">↓</span>
                <br>
                <!--パンくずリスト-->
                <span id="topicPathList"></span>
                <br>
                <!--カレントトピック-->
                <span id="currentTopic" style="font-size:large"></span>
                <br>
                <!--リスト本体-->
                <span id="show_result"></span>
                <br>
                <!--新規編集欄-->
                <!--                                <span id="new_edit"></span>-->
                <input type="text" id="new_edit" data-id="new_edit" class="topicText" style="display:none">
                <br>
                <!--トピック追加ボタン-->
                <span id="addTopic">+</span>
                <br>
            </div>
            <div class="panel" id="page2" data-title="アプリについて">
                <div id="oss1">
                    <input type="button" value="OSSライセンス" onclick="openOss()" style="display:;width:300px;height:30px;">
                    <br>
                    <br>
                </div>
                <div id="oss2" style="display:none">
                    <br> OSSライセンス
                    <br> -----------------------
                    <br> Cordova 2.9.0.0
                    <br>
                    <br> Licensed to the Apache Software Foundation (ASF) under one
                    <br> or more contributor license agreements. See the NOTICE file
                    <br> distributed with this work for additional information
                    <br> regarding copyright ownership. The ASF licenses this file
                    <br> to you under the Apache License, Version 2.0 (the
                    <br> "License"); you may not use this file except in compliance
                    <br> with the License. You may obtain a copy of the License at
                    <br>
                    <br> http://www.apache.org/licenses/LICENSE-2.0
                    <br>
                    <br> Unless required by applicable law or agreed to in writing,
                    <br> software distributed under the License is distributed on an
                    <br> "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
                    <br> KIND, either express or implied. See the License for the
                    <br> specific language governing permissions and limitations
                    <br> under the License.
                    <br>
                    <br>
                </div>
                <!-- テスト用に初期状態に戻るようにしてある -->
                <!-- <a href="URL" target="_blank"> -->
                <input type="button" value="アプリのトップに戻る" onclick="appliTop();" style="width:300px;height:30px;">
                <br>
            </div>
        </div>
        <nav id="left">
            <div class="view active">
                <header>
                    <h1>メニュー</h1>
                </header>
                <div class="pages">
                    <div class="panel active" id="navPage1" data-title="Foobar">
                        <ul class="list">
                            <li id="drawer_top_rect" style="display: none;">
                                <a id="for_top" href="#main" onclick="$.afui.clearHistory(); changeVisivility(true);">アプリTOP</a>
                            </li>
                            <li id="drawer_about_rect">
                                <a href="#page2" onclick="$.afui.clearHistory(); changeVisivility(false);">このアプリについて</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </div>
</body>

</html>